<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blocky Racer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; overflow:hidden; background:black; font-family:Arial }
#loader { position:fixed; inset:0; background:black; color:white; display:flex; align-items:center; justify-content:center; z-index:999 }
#hud { position:absolute; top:20px; right:20px; color:white; text-align:right; text-shadow:2px 2px 4px black }
#menuBtn { position:absolute; bottom:20px; right:20px; background:#000a; color:white; padding:10px 20px; border:2px solid white; cursor:pointer }
#sideMenu { position:absolute; top:0; right:-320px; width:300px; height:100%; background:#000e; color:white; padding:20px; transition:0.3s }
#sideMenu.open { right:0 }
.menu-opt { background:#333; padding:15px; margin:10px 0; cursor:pointer; text-align:center }
.menu-opt.active { background:#4CAF50; font-weight:bold }
#overlay { position:fixed; inset:0; background:#000d; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100 }
.big-btn { font-size:28px; padding:20px 50px; background:#4CAF50; border:none; border-radius:10px; cursor:pointer; margin-top:20px }
.bt-btn { padding:15px 40px; background:#2196F3; border:none; border-radius:30px; font-size:20px; cursor:pointer; margin-top:20px }
.bt-btn.connected { background:#607D8B }
</style>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
<div id="loader">Loading…</div>
<div id="root"></div>

<script type="text/babel">
const { useRef, useEffect, useState } = React;

const SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
const SENSOR_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
const VIBE_CHAR_UUID   = "19b10002-e8f2-537e-4f6c-d104768a1214";

function BlockyRacer() {
  const mountRef = useRef(null);
  const crashTriggeredRef = useRef(false);
  const btRef = useRef({ device:null, sensorChar:null, vibeChar:null, tilt:0 });

  const [started, setStarted] = useState(false);
  const [gameOver, setGameOver] = useState(false);
  const [score, setScore] = useState(0);
  const [highScore, setHighScore] = useState(localStorage.getItem("hs")||0);
  const [menuOpen, setMenuOpen] = useState(false);
  const [btConnected, setBtConnected] = useState(false);

  /* ---------------- BLE ---------------- */

  const connectBluetooth = async () => {
    const device = await navigator.bluetooth.requestDevice({ filters:[{services:[SERVICE_UUID]}] });
    device.addEventListener("gattserverdisconnected", ()=>setBtConnected(false));
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);

    const sensorChar = await service.getCharacteristic(SENSOR_CHAR_UUID);
    await sensorChar.startNotifications();
    sensorChar.addEventListener("characteristicvaluechanged", e=>{
      const v = parseFloat(new TextDecoder().decode(e.target.value));
      if(!isNaN(v)) btRef.current.tilt = v;
    });

    const vibeChar = await service.getCharacteristic(VIBE_CHAR_UUID);
    btRef.current = { device, sensorChar, vibeChar, tilt:0 };
    setBtConnected(true);
  };

  const sendVibration = async () => {
    if (!btRef.current.vibeChar) return;
    if (crashTriggeredRef.current) return;
    crashTriggeredRef.current = true;

    try {
      await btRef.current.vibeChar.writeValue(new TextEncoder().encode("1"));
    } catch(e) {}
  };

  /* ---------------- THREE ---------------- */

  useEffect(()=>{
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    mountRef.current.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff,0.6));
    const dl = new THREE.DirectionalLight(0xffffff,1);
    dl.position.set(50,100,50);
    scene.add(dl);

    const road = new THREE.Mesh(
      new THREE.PlaneGeometry(30,1000),
      new THREE.MeshLambertMaterial({color:0x444444})
    );
    road.rotation.x = -Math.PI/2;
    scene.add(road);

    const player = new THREE.Mesh(
      new THREE.BoxGeometry(2,1,4),
      new THREE.MeshLambertMaterial({color:0xff0055})
    );
    player.position.y = 0.6;
    scene.add(player);

    const cars = [];
    const lanes = [-10,0,10];
    let speed = 0;

    function createOpponent(type,color){
      const m = new THREE.Mesh(
        new THREE.BoxGeometry(2,1,4),
        new THREE.MeshLambertMaterial({color})
      );
      m.position.y = 0.6;
      if(type==="ambulance") m.rotation.y = Math.PI;   // ambulance only
      return m;
    }

    function animate(){
      requestAnimationFrame(animate);
      if(!started || gameOver || menuOpen){ renderer.render(scene,camera); return; }

      speed = Math.min(speed+0.02, 0.9);
      setScore(s=>s+1);

      const DEADZONE = 5;
      const MAX = 25;
      let steer = 0;
      const tilt = btRef.current.tilt;

      if(Math.abs(tilt)>DEADZONE){
        let n = (Math.abs(tilt)-DEADZONE)/(MAX-DEADZONE);
        n = Math.min(n,1);
        steer = Math.sign(tilt)*n*n*0.7;
      }

      player.position.x = THREE.MathUtils.clamp(player.position.x+steer,-13,13);

      if(Math.random()<0.02){
        const t = Math.random()<0.3?"ambulance":"car";
        const c = createOpponent(t, t==="ambulance"?0xff0000:0x00aaff);
        c.position.z = -250;
        c.position.x = lanes[Math.floor(Math.random()*3)];
        if(t!=="ambulance") c.rotation.y = Math.PI;
        scene.add(c);
        cars.push(c);
      }

      for(let i=cars.length-1;i>=0;i--){
        const c = cars[i];
        c.position.z += speed+0.6;
        if(Math.abs(c.position.z)<4 && Math.abs(c.position.x-player.position.x)<3){
          sendVibration();
          setTimeout(()=>{
            setGameOver(true);
            if(score>highScore){ localStorage.setItem("hs",score); setHighScore(score); }
          },120);
        }
        if(c.position.z>80){ scene.remove(c); cars.splice(i,1); }
      }

      camera.position.set(player.position.x*0.6,10,35);
      camera.lookAt(player.position.x*0.3,2,-50);
      renderer.render(scene,camera);
    }

    animate();
    document.getElementById("loader").style.display="none";
  },[started,gameOver]);

  const restart = ()=>{
    crashTriggeredRef.current = false;
    setGameOver(false);
    setScore(0);
  };

  return (
    <>
      <div ref={mountRef} style={{width:"100vw",height:"100vh"}}/>
      {started && <div id="hud"><div>Score: {score}</div><div>High: {highScore}</div></div>}
      {!started &&
        <div id="overlay">
          <h1>BLOCKY RACER</h1>
          <button className={"bt-btn "+(btConnected?"connected":"")} onClick={btConnected?null:connectBluetooth}>
            {btConnected?"✓ PAIRED":"PAIR CONTROLLER"}
          </button>
          <button className="big-btn" onClick={()=>setStarted(true)}>START</button>
        </div>
      }
      {gameOver &&
        <div id="overlay">
          <h1>CRASHED</h1>
          <div>Score: {score}</div>
          <button className="big-btn" onClick={restart}>RESTART</button>
        </div>
      }
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<BlockyRacer/>);
</script>
</body>
</html>
